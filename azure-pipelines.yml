trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  S3_BUCKET: munus-intranet
  CLOUDFRONT_DISTRIBUTION_ID: E2ZSVCW95D8Y5I

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Use Node.js 20'

  # Cache npm modules
  - task: Cache@2
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      path: $(Pipeline.Workspace)/.npm
    displayName: 'Cache npm packages'

  # Install dependencies & build
  - script: |
      npm ci --cache $(Pipeline.Workspace)/.npm --prefer-offline
      rm -rf out  # ensure old out is gone
      npm run build
    displayName: 'Build Next.js app'

  # Install AWS CLI
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
    displayName: 'Use Python 3 (for AWS CLI)'

  - script: |
      pip install awscli --upgrade --user
      export PATH=$PATH:$HOME/.local/bin
      aws --version
    displayName: 'Install AWS CLI'

  # Deploy /out to S3
  - script: |
      export PATH=$PATH:$HOME/.local/bin
      echo "Clearing bucket $(S3_BUCKET)..."
      aws s3 rm s3://$(S3_BUCKET) --recursive || true
      echo "Uploading new build from /out..."
      aws s3 cp out/ s3://$(S3_BUCKET)/ --recursive
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: ap-southeast-1
    displayName: 'Deploy to S3'

  # Invalidate CloudFront cache
  - script: |
      export PATH=$PATH:$HOME/.local/bin
      aws cloudfront create-invalidation \
        --distribution-id $(CLOUDFRONT_DISTRIBUTION_ID) \
        --paths "/*"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: ap-southeast-1
    displayName: 'Invalidate CloudFront'
